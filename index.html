<!DOCTYPE html>
<html>
<head>
  <title>ThingSpeak Chart.js Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0"></script>
  <style>
    body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; }
    canvas { background-color: #fff; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>Moisture Chart – PK Silo [PEKAWAI MILL]</h2>
  <p style="font-size: 14px; color: gray;">
  GitHub Version: <strong>2025-05-06 20:56</strong>
  </p>
  <label for="startDateInput">Start Date: </label>
  <input type="date" id="startDateInput">
  <label for="startTimeInput" style="margin-left: 20px;">Start Time:</label>
  <input type="time" id="startTimeInput" value="00:00:00">

  <label for="endDateInput" style="margin-left: 20px;">End Date: </label>
  <input type="date" id="endDateInput">
  <label for="endTimeInput" style="margin-left: 20px;">End Time:</label>
  <input type="time" id="endTimeInput" value="23:59:59">
  
  <button onclick="loadChart()" style="margin-left: 20px;">Load Chart</button>

  <select id="stepSize" style="margin-left: 20px;">
  <option value="1H">1H</option>
  <option value="1D" selected>1D</option>
  <option value="1W">1W</option>
  </select>

  <button onclick="moveWindow('backward')" style="margin-left: 10px;">←</button>
  <button onclick="moveWindow('forward')">→</button>
  
  <br><br>
  <canvas id="myChart" width="1500" height="650"></canvas>
  <p>
  Raw ThingSpeak chart URL:<br>
  <a id="tsLink" href="#" target="_blank" style="color:blue; word-break: break-all;"></a>
  </p>
  <p id="fetchStats" style="font-size: 14px; color: darkslategray;"></p>
  <script>
    const channelId = "2793071";
    const field = 1;
    const apiKey = "BL9H0JXPJEA08H3G";
    let moistureChart = null;

    function loadChart() {
      const startDateInput = document.getElementById("startDateInput").value;
      const endDateInput = document.getElementById("endDateInput").value;
      const startTimeInput = document.getElementById("startTimeInput").value || "00:00:00";
      const endTimeInput = document.getElementById("endTimeInput").value || "23:59:59";
      
      const startDate = new Date(`${startDateInput}T${startTimeInput}Z`);
      const endDate = new Date(`${endDateInput}T${endTimeInput}Z`);
      const url = `https://api.thingspeak.com/channels/${channelId}/fields/${field}.json?api_key=${apiKey}&start=${startDateInput}%20${startTimeInput}&end=${endDateInput}%20${endTimeInput}`;

      const t0 = performance.now();
      fetch(url)
        .then(response => response.text())
        .then(text => {
          const sizeKB = (new Blob([text]).size / 1024).toFixed(2);
          const data = JSON.parse(text);
          const feeds = data.feeds.filter(entry => {
            const t = new Date(entry.created_at);
            return t >= startDate && t <= endDate;
          });
          const t1 = performance.now();
          const fetchTime = (t1 - t0).toFixed(1);
         
          const timestamps = feeds.map(entry => new Date(entry.created_at));
          
          //const values = feeds.map(entry => parseFloat(entry[`field${field}`]));
          const values = feeds.map(entry => {
          const val = entry[`field${field}`];
          return val === null || val === "" ? null : parseFloat(val);
          });

          // Update stats
          const statLine = `Fetched ${feeds.length} points, ~${sizeKB} KB, in ${fetchTime} ms.`;
          document.getElementById("fetchStats").textContent = statLine;
          
          const ctx = document.getElementById("myChart").getContext("2d");
          
          if (moistureChart !== null) {
            moistureChart.destroy();
          }
          
          moistureChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: timestamps,
              datasets: [{
                label: "Moisture (%)",
                data: values,
                stepped: true,
                borderColor: "black",         // thin black line
                backgroundColor: "blue",      // blue dots
                pointRadius: 2,
                borderWidth: 0.5,               // thinner line
                spanGaps: false,              // preserve visual gaps for null
                fill: false
              }]
            },
            options: {
              scales: {
                y: {
                  min: -2,
                  max: 20
                },
                x: {
                  type: 'time',
                  time: {
                    tooltipFormat: 'MMM dd, yyyy HH:mm',
                    displayFormats: {
                      hour: 'MMM dd HH:mm',
                      day: 'MMM dd',
                    }
                  },
                  title: {
                    display: true,
                    text: 'Timestamp'
                  }
                }
              },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        });
     // Update link to raw ThingSpeak chart
    const thingSpeakLink = url;
    document.getElementById("tsLink").href = thingSpeakLink;
    document.getElementById("tsLink").textContent = thingSpeakLink;
       
    } // end of function loadChart()

function setRange(start, end) {
  document.getElementById("startDateInput").value = start.toISOString().slice(0, 10);
  document.getElementById("startTimeInput").value = start.toTimeString().slice(0, 8);
  document.getElementById("endDateInput").value = end.toISOString().slice(0, 10);
  document.getElementById("endTimeInput").value = end.toTimeString().slice(0, 8);
}
    
window.onload = function() {
  const end = new Date();
  const start = new Date(end.getTime() - 24 * 3600 * 1000); // 1 day back
  setRange(start, end);
  loadChart();
}

function moveWindow(direction) {
  const startDateInput = document.getElementById("startDateInput").value;
  const endDateInput = document.getElementById("endDateInput").value;
  const startTimeInput = document.getElementById("startTimeInput").value;
  const endTimeInput = document.getElementById("endTimeInput").value;

  const start = new Date(`${startDateInput}T${startTimeInput}`);
  const end = new Date(`${endDateInput}T${endTimeInput}`);
  const step = document.getElementById("stepSize").value;

  let deltaMs = 0;
  if (step === "1H") deltaMs = 3600 * 1000;
  if (step === "1D") deltaMs = 24 * 3600 * 1000;
  if (step === "1W") deltaMs = 7 * 24 * 3600 * 1000;
  if (direction === "backward") deltaMs *= -1;

  const newStart = new Date(start.getTime() + deltaMs);
  const newEnd = new Date(end.getTime() + deltaMs);

  setRange(newStart, newEnd);

  loadChart();
}


    
</script>
</body>
</html>
