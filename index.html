<!DOCTYPE html>
<html>
<head>
  <title>ThingSpeak Chart.js Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0"></script>
  <style>
    body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; }
    canvas { background-color: #fff; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>Moisture Chart â€“ PK Silo [PEKAWAI MILL]</h2>
  <p style="font-size: 14px; color: gray;">
  GitHub Version: <strong>2025-05-06 08:40</strong>
  </p>
  <label for="startDateInput">Start Date: </label>
  <input type="date" id="startDateInput">
  <label for="startTimeInput" style="margin-left: 20px;">Start Time:</label>
  <input type="time" id="startTimeInput" value="00:00:00">

  <label for="endDateInput" style="margin-left: 20px;">End Date: </label>
  <input type="date" id="endDateInput">
  <label for="endTimeInput" style="margin-left: 20px;">End Time:</label>
  <input type="time" id="endTimeInput" value="23:59:59">
  
  <button onclick="loadChart()" style="margin-left: 20px;">Load Chart</button>
  
  <br><br>
  <canvas id="myChart" width="1500" height="650"></canvas>
  <p>
  Raw ThingSpeak chart URL:<br>
  <a id="tsLink" href="#" target="_blank" style="color:blue; word-break: break-all;"></a>
  </p>
  <script>
    const channelId = "2793071";
    const field = 1;
    const apiKey = "BL9H0JXPJEA08H3G";
    let moistureChart = null;

    function loadChart() {
      const startDateInput = document.getElementById("startDateInput").value;
      const endDateInput = document.getElementById("endDateInput").value;
      const startTimeInput = document.getElementById("startTimeInput").value || "00:00:00";
      const endTimeInput = document.getElementById("endTimeInput").value || "23:59:59";
      
      const startDate = new Date(`${startDateInput}T${startTimeInput}Z`);
      const endDate = new Date(`${endDateInput}T${endTimeInput}Z`);
      const url = `https://api.thingspeak.com/channels/${channelId}/fields/${field}.json?api_key=${apiKey}&start=${startDateInput}%20${startTimeInput}&end=${endDateInput}%20${endTimeInput}`;
    
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const feeds = data.feeds.filter(entry => {
            const t = new Date(entry.created_at);
            return t >= startDate && t <= endDate;
          });
    
          const timestamps = feeds.map(entry => new Date(entry.created_at));
          
          //const values = feeds.map(entry => parseFloat(entry[`field${field}`]));
          const values = feeds.map(entry => {
          const val = entry[`field${field}`];
          return val === null || val === "" ? null : parseFloat(val);
          });
          
          const ctx = document.getElementById("myChart").getContext("2d");
          
          if (moistureChart !== null) {
            moistureChart.destroy();
          }
          
          moistureChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: timestamps,
              datasets: [{
                label: "Moisture (%)",
                data: values,
                borderColor: "black",         // thin black line
                backgroundColor: "blue",      // blue dots
                pointRadius: 2,
                borderWidth: 0.5,               // thinner line
                spanGaps: false,              // preserve visual gaps for null
                fill: false
              }]
            },
            options: {
              scales: {
                y: {
                  min: -2,
                  max: 20
                },
                x: {
                  type: 'time',
                  time: {
                    tooltipFormat: 'MMM dd, yyyy HH:mm',
                    displayFormats: {
                      hour: 'MMM dd HH:mm',
                      day: 'MMM dd',
                    }
                  },
                  title: {
                    display: true,
                    text: 'Timestamp'
                  }
                }
              },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        });
     // Update link to raw ThingSpeak chart
    const thingSpeakLink = url;
    document.getElementById("tsLink").href = thingSpeakLink;
    document.getElementById("tsLink").textContent = thingSpeakLink;
    } // end of function loadChart()


window.onload = function() {
  const today = new Date();
  const prior = new Date();
  prior.setDate(today.getDate() - 1);

  document.getElementById("startDateInput").value = prior.toISOString().split('T')[0];
  document.getElementById("endDateInput").value = today.toISOString().split('T')[0];

  loadChart(); // auto-load on page open
}


    
</script>
</body>
</html>
