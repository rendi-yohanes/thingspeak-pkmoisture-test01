<!DOCTYPE html>
<html>
<head>
  <title>ThingSpeak Chart.js Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; }
    canvas { background-color: #fff; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>Moisture Chart â€“ PK Silo</h2>
  <p style="font-size: 14px; color: gray;">
  GitHub Version: <strong>2025-05-05 16:18</strong>
  </p>
  <label for="startDateInput">Start Date: </label>
  <input type="date" id="startDateInput">
  <label for="endDateInput" style="margin-left: 20px;">End Date: </label>
  <input type="date" id="endDateInput">
  <button onclick="loadChart()" style="margin-left: 20px;">Load Chart</button>
  <br><br>
  <canvas id="myChart" width="1200" height="650"></canvas>
  <p>
  Raw ThingSpeak chart URL:<br>
  <a id="tsLink" href="#" target="_blank" style="color:blue; word-break: break-all;"></a>
  </p>
  <script>
    const channelId = "2793071";
    const field = 1;
    const apiKey = "BL9H0JXPJEA08H3G";

    const startInput = document.getElementById("startDateInput").value;
    const endInput = document.getElementById("endDateInput").value;

    const startDate = new Date(startInput + "T00:00:00Z");
    const endDate = new Date(endInput + "T23:59:59Z");

    function loadChart() {
      const startInput = document.getElementById("startDateInput").value;
      const endInput = document.getElementById("endDateInput").value;
    
      const startDate = new Date(startInput + "T00:00:00Z");
      const endDate = new Date(endInput + "T23:59:59Z");
    
      const url = `https://api.thingspeak.com/channels/${channelId}/fields/${field}.json?api_key=${apiKey}&start=${startInput}%2000:00:00&end=${endInput}%2023:59:59`;
    
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const feeds = data.feeds.filter(entry => {
            const t = new Date(entry.created_at);
            return t >= startDate && t <= endDate;
          });
    
          const timestamps = feeds.map(entry => new Date(entry.created_at).toLocaleString());
          const values = feeds.map(entry => parseFloat(entry[`field${field}`]));
    
          const ctx = document.getElementById("myChart").getContext("2d");
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: timestamps,
              datasets: [{
                label: "Moisture (%)",
                data: values,
                borderColor: "#0000FF",
                backgroundColor: "rgba(0,0,255,0.1)",
                fill: false,
                pointRadius: 0.5,
                borderWidth: 2
              }]
            },
            options: {
              scales: {
                y: {
                  min: -2,
                  max: 20
                },
                x: {
                  ticks: { autoSkip: true, maxTicksLimit: 20 }
                }
              },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        });
    }

window.onload = function() {
  const today = new Date();
  const prior = new Date();
  prior.setDate(today.getDate() - 3);

  document.getElementById("startDateInput").value = prior.toISOString().split('T')[0];
  document.getElementById("endDateInput").value = today.toISOString().split('T')[0];

  loadChart(); // auto-load on page open
}

// Update link to raw ThingSpeak chart
const thingSpeakLink = `https://thingspeak.com/channels/${channelId}/charts/${field}?start=${startInput}%2000:00:00&end=${endInput}%2023:59:59&color=0000FF&yaxismin=-2&yaxismax=20`;
document.getElementById("tsLink").href = thingSpeakLink;
document.getElementById("tsLink").textContent = thingSpeakLink;
    
</script>
</body>
</html>
